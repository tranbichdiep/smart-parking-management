{% extends 'layout.html' %} {% block title %}Bảng điều khiển Vận hành{% endblock
%} {% block extra_head %}
<style>
  [x-cloak] {
    display: none !important;
  }
</style>
{% endblock %} {% block content %}
<div class="container mx-auto pb-12" x-data="parkingSystem()" x-init="init()">
  <div
    x-show="generalMessage"
    x-transition
    class="fixed top-20 right-5 w-auto max-w-sm p-4 rounded-lg shadow-xl text-white z-[100]"
    :class="{
            'bg-green-500': messageType === 'success',
            'bg-red-500': messageType === 'error',
            'bg-blue-500': messageType === 'info'
        }"
    role="alert"
  >
    <p class="font-bold" x-text="generalMessage"></p>
    <div
      class="absolute bottom-0 left-0 h-1 bg-white/50"
      :style="`width: ${messageProgress}%`"
    ></div>
  </div>

  <div
    id="waiting-for-scan"
    x-show="currentState === 'waiting'"
    x-transition:enter.duration.500ms
    class="mt-6 bg-white rounded-xl shadow-lg overflow-hidden"
  >
    <div
      class="bg-gradient-to-r from-slate-600 to-slate-700 p-4 text-white flex justify-between items-center"
    >
      <h3 class="text-xl font-bold flex items-center gap-2">
        <i class="fa-solid fa-video"></i> GIÁM SÁT CỔNG VÀO
      </h3>
      <div
        class="flex items-center gap-2 text-sm font-medium px-3 py-1 rounded-full bg-black/20"
      >
        <template x-if="isPolling">
          <span class="relative flex h-3 w-3">
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"
            ></span>
            <span
              class="relative inline-flex rounded-full h-3 w-3 bg-green-500"
            ></span>
          </span>
        </template>
        <span
          x-text="isPolling ? 'Hệ thống đang hoạt động' : 'Mất kết nối server'"
          :class="isPolling ? 'text-green-300' : 'text-red-300'"
        ></span>
      </div>
    </div>

    <div class="p-6 grid grid-cols-12 gap-6">
      <div class="col-span-12 lg:col-span-8 space-y-4">
        <div
          class="border-2 border-slate-200 rounded-lg p-1 bg-slate-50 aspect-[4/3] overflow-hidden relative group shadow-inner"
        >
          <div
            class="absolute top-2 left-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded flex items-center gap-1 z-10 opacity-80 group-hover:opacity-100 transition"
          >
            <span
              class="animate-pulse w-2 h-2 bg-white rounded-full inline-block"
            ></span>
            LIVE VIEW
          </div>
          <img
            src="{{ url_for('video_feed_in') }}"
            alt="Video trực tiếp cổng vào đang tải..."
            class="w-full h-full object-cover bg-slate-800 text-slate-300 rounded"
            onerror="this.onerror=null; this.src='{{ url_for('static', filename='placeholder.jpg') }}'; this.parentElement.classList.add('border-red-500');"
          />
        </div>
        <p class="text-sm text-slate-500 italic text-center">
          <i class="fa-solid fa-info-circle"></i> Camera tự động hiển thị khi
          tải trang.
        </p>
      </div>

      <div class="col-span-12 lg:col-span-4 flex flex-col justify-center">
        <div
          class="text-center p-8 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50/50 h-full flex flex-col items-center justify-center gap-4"
        >
          <div
            class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100"
          >
            <i
              class="fa-solid fa-id-card-clip text-4xl text-indigo-500 animate-pulse-slow"
            ></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">
              Đang chờ quét thẻ...
            </h2>
            <p class="text-slate-500 text-sm px-4">
              Vui lòng quét thẻ tại đầu đọc để thực hiện xe vào hoặc xe ra. Giao
              diện sẽ tự động chuyển đổi.
            </p>
          </div>
          <div class="mt-4">
            <span
              class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-indigo-500 bg-white border border-indigo-100 transition ease-in-out duration-150 cursor-not-allowed"
            >
              <svg
                class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              Đang lắng nghe tín hiệu...
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div
    id="check-in-section"
    x-show="currentState === 'checking_in'"
    x-cloak
    x-transition:enter.duration.300ms
    class="mt-6 bg-white rounded-xl shadow-lg overflow-hidden"
  >
    <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-4 text-white">
      <h3
        class="text-2xl font-bold"
        x-text="checkoutData.ticket_type === 'monthly' ? 'GỬI XE - VÉ THÁNG' : 'GỬI XE - VÉ VÃNG LAI'"
      >
        GỬI XE - NHẬN THÔNG TIN (VÃNG LAI)
      </h3>
    </div>
    <div class="p-6 grid grid-cols-12 gap-6">
      <div class="col-span-12 lg:col-span-7 space-y-4">
        <div
          class="border rounded-lg p-2 bg-slate-50 aspect-[4/3] overflow-hidden"
        >
          <img
            src="{{ url_for('video_feed_in') }}"
            alt="Video trực tiếp (Vào)"
            class="w-full h-full object-cover bg-black text-white rounded"
          />
        </div>
        <div
          class="border rounded-lg p-2 bg-slate-50 aspect-[4/3] overflow-hidden"
        >
          <img
            :src="snapshotUrl"
            class="rounded w-full h-full object-cover"
            alt="Ảnh chụp biển số vào"
          />
        </div>
      </div>
      <div class="col-span-12 lg:col-span-5">
        <div class="h-full flex flex-col">
          <h4 class="text-base font-semibold mb-3 text-slate-800">
            Thông tin Vào bãi
          </h4>
          <div
            class="space-y-2 text-slate-700 text-sm p-4 bg-slate-50/50 rounded-lg border"
          >
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">ID Thẻ:</span>
              <span class="font-mono" x-text="checkoutData.card_id"></span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">Chủ thẻ:</span>
              <span
                class="font-semibold"
                x-text="checkoutData.holder_name"
              ></span>
            </div>
            <div>
              <label
                for="license_plate_in"
                class="block text-slate-500 font-medium mb-1"
                >Biển số xe:</label
              >
              <input
                type="text"
                id="license_plate_in"
                x-model="licensePlate"
                @keyup.enter="confirmPendingEntry()"
                class="w-full px-3 py-2 text-base font-mono border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                :placeholder="checkoutData.ticket_type === 'monthly' ? 'Biển số đã đăng ký' : 'Nhập biển số vãng lai'"
                :disabled="checkoutData.ticket_type === 'monthly'"
                :class="checkoutData.ticket_type === 'monthly' ? 'bg-gray-100 text-gray-500' : 'bg-white'"
                autofocus
              />
            </div>
            <hr class="my-2 border-dashed" />
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">Vào bãi (Scan):</span>
              <span
                class="text-slate-600"
                x-text="checkoutData.entry_time"
              ></span>
            </div>
          </div>
          <div class="mt-3 flex items-center gap-3">
            <button
              @click="confirmPendingEntry()"
              class="flex-1 py-2.5 text-sm font-semibold text-white rounded-md hover:bg-green-700 transition shadow"
              :class="checkoutData.ticket_type === 'monthly' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'"
            >
              <span
                x-text="checkoutData.ticket_type === 'monthly' ? 'XÁC NHẬN VÉ THÁNG VÀO' : 'XÁC NHẬN VÀO'"
              ></span>
            </button>
            <button
              @click="cancelPendingAction()"
              class="py-2.5 px-4 text-sm font-semibold text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 transition"
            >
              HỦY
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    id="check-out-section"
    x-show="currentState === 'checking_out'"
    x-cloak
    x-transition:enter.duration.300ms
    class="mt-6 bg-white rounded-xl shadow-lg overflow-hidden"
  >
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4 text-white">
      <h3 class="text-2xl font-bold">XE RA BÃI - XÁC NHẬN THANH TOÁN</h3>
    </div>
    <div class="p-6 grid grid-cols-12 gap-6">
      <div class="col-span-12 lg:col-span-7 space-y-4">
        <div
          class="border rounded-lg p-2 bg-slate-50 aspect-[4/3] overflow-hidden"
        >
          <img
            src="{{ url_for('video_feed_out') }}"
            alt="Video trực tiếp (Ra)"
            class="w-full h-full object-cover bg-black text-white rounded"
          />
        </div>
        <div
          class="border rounded-lg p-2 bg-slate-50 aspect-[4/3] overflow-hidden flex flex-col"
        >
          <div class="text-sm font-semibold text-center mb-1 text-slate-600">
            ẢNH LÚC VÀO ĐỂ ĐỐI CHIẾU
          </div>
          <img
            :src="checkoutData.entry_snapshot_url || snapshotUrl"
            class="rounded w-full object-cover shadow-inner flex-1 min-h-0"
            alt="Ảnh đối chiếu"
          />
        </div>
      </div>

      <div class="col-span-12 lg:col-span-5">
        <div class="h-full flex flex-col">
          <h4 class="text-base font-semibold mb-3 text-slate-800">
            Thông tin Giao dịch
          </h4>
          <div
            class="space-y-2 text-slate-700 text-sm p-4 bg-slate-50/50 rounded-lg border"
          >
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">Biển số xe:</span
              ><span
                class="font-mono font-semibold text-slate-800"
                x-text="checkoutData.license_plate"
              ></span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">ID Thẻ:</span
              ><span class="font-mono" x-text="checkoutData.card_id"></span>
            </div>
            <hr class="my-2 border-dashed" />
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">Vào bãi:</span
              ><span
                class="text-slate-600"
                x-text="checkoutData.entry_time"
              ></span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">Ra bãi:</span
              ><span
                class="text-slate-600"
                x-text="checkoutData.exit_time"
              ></span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-slate-500">Tổng thời gian:</span
              ><span
                class="font-semibold"
                x-text="checkoutData.duration"
              ></span>
            </div>
          </div>
          <div
            x-show="checkoutData.fee > 0"
            class="mt-3 p-4 text-center bg-red-50 rounded-lg border border-red-200"
          >
            <p
              class="text-xs font-semibold text-red-800 uppercase tracking-wider"
            >
              TỔNG TIỀN (VÃNG LAI)
            </p>
            <p class="text-4xl font-extrabold text-red-600 tracking-tight my-1">
              <span
                x-text="(checkoutData.fee || 0).toLocaleString('vi-VN')"
              ></span
              ><span class="text-2xl font-semibold">VNĐ</span>
            </p>
          </div>
          <div x-show="checkoutData.ticket_type === 'monthly' && checkoutData.fee > 0" class="text-red-600 font-bold text-center mt-2 animate-pulse">
            ⚠️ THẺ ĐÃ HẾT HẠN - TÍNH PHÍ NHƯ VÃNG LAI
          </div>
          <div
            x-show="checkoutData.fee === 0"
            class="mt-3 p-4 text-center bg-blue-50 rounded-lg border border-blue-200"
          >
            <p
              class="text-xs font-semibold text-blue-800 uppercase tracking-wider"
            >
              VÉ THÁNG
            </p>
            <p class="text-2xl font-bold text-blue-600 tracking-tight my-1">
              KHÔNG THU PHÍ
            </p>
          </div>
          <div class="mt-3 flex items-center gap-3">
            <button
              @click="confirmPendingExit()"
              class="flex-1 py-2.5 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition shadow"
            >
              <span
                x-text="checkoutData.fee > 0 ? 'XÁC NHẬN THU TIỀN' : 'XÁC NHẬN XE RA (VÉ THÁNG)'"
              ></span>
            </button>
            <button
              @click="cancelPendingAction()"
              class="py-2.5 px-4 text-sm font-semibold text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 transition"
            >
              HỦY
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function parkingSystem() {
    return {
      currentState: "waiting",
      isPolling: false,
      pollInterval: null,
      generalMessage: "",
      messageType: "info",
      messageTimer: null,
      messageProgress: 100,
      licensePlate: "",
      snapshotUrl: "{{ url_for('static', filename='placeholder.jpg') }}",
      checkoutData: {
        poll_id: null,
        card_id: null,
        entry_time: null,
        action_type: null,
        transaction_id: null,
        license_plate: null,
        exit_time: null,
        duration: null,
        fee: 0,
        entry_snapshot_url: null,
        holder_name: "Khách vãng lai",
        ticket_type: "daily",
      },
      init() {
        this.startPolling();
      },
      startPolling() {
        if (this.pollInterval) clearInterval(this.pollInterval);
        this.isPolling = true;
        this.fetchPendingScan();
        this.pollInterval = setInterval(() => {
          if (this.currentState === "waiting") {
            this.fetchPendingScan();
          }
        }, 2000);
      },
      stopPolling() {
        if (this.pollInterval) clearInterval(this.pollInterval);
        this.isPolling = false;
      },
      resetView() {
        this.currentState = "waiting";
        this.licensePlate = "";
        this.snapshotUrl =
          "{{ url_for('static', filename='placeholder.jpg') }}";
        this.checkoutData = {
          poll_id: null,
          card_id: null,
          entry_time: null,
          fee: 0,
          transaction_id: null,
          license_plate: null,
          exit_time: null,
          duration: null,
          entry_snapshot_url: null,
          holder_name: "Khách vãng lai",
          ticket_type: "daily",
        };
        this.startPolling();
      },
      displayMessage(message, type = "info", duration = 4000) {
        this.generalMessage = message;
        this.messageType = type;
        this.messageProgress = 100;
        clearInterval(this.messageTimer);
        if (duration > 0) {
          const interval = 50;
          const steps = duration / interval;
          let currentStep = 0;
          this.messageTimer = setInterval(() => {
            currentStep++;
            this.messageProgress = 100 - (currentStep / steps) * 100;
            if (currentStep >= steps) {
              clearInterval(this.messageTimer);
              this.generalMessage = "";
            }
          }, interval);
        }
      },
      async fetchPendingScan() {
        try {
          const response = await fetch("/api/gate/get_pending_scans");
          if (!response.ok) {
            throw new Error("Server error");
          }
          const result = await response.json();
          this.isPolling = true;

          // === [MỚI] XỬ LÝ CẢNH BÁO THẺ LẠ ===
          // Nếu nhận được action_type là 'alert', hiện thông báo lỗi và không làm gì tiếp
          if (result && result.action_type === 'alert') {
              this.displayMessage(result.message, "error", 5000); // Hiện màu đỏ trong 5s
              return; 
          }
          // ====================================

          if (result && result.card_id) {
            this.stopPolling();
            this.checkoutData = result;
            this.checkoutData.ticket_type = result.ticket_type || "daily";
            if (result.action_type === "entry") {
              this.licensePlate = result.license_plate || "";
              this.checkoutData.holder_name =
                result.holder_name || "Khách vãng lai";
              this.checkoutData.ticket_type = result.ticket_type || "daily";
              this.displayMessage(
                `Thẻ vào ${result.card_id} đang chờ!`,
                "info"
              );
              this.currentState = "checking_in";
              setTimeout(() => {
                const plateInput = document.getElementById("license_plate_in");
                if (plateInput) {
                  plateInput.focus();
                  if (this.checkoutData.ticket_type === "daily") {
                    plateInput.select();
                  }
                }
              }, 100);
            } else if (result.action_type === "exit") {
              this.displayMessage(
                `Thẻ ra ${result.card_id} chờ thu phí!`,
                "info"
              );
              this.currentState = "checking_out";
            }
          }
        } catch (error) {
          console.error("Lỗi Polling:", error);
          this.isPolling = false;
          // Tạm tắt thông báo lỗi kết nối liên tục để tránh rối mắt
          // this.displayMessage("Lỗi kết nối khi lắng nghe cổng!", "error", 2000);
          this.stopPolling();
          setTimeout(() => this.startPolling(), 5000);
        }
      },
      async confirmPendingEntry() {
        if (!this.licensePlate.trim()) {
          alert("Vui lòng nhập biển số xe.");
          return;
        }
        try {
          const response = await fetch("/api/confirm_pending_entry", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              poll_id: this.checkoutData.poll_id,
              card_id: this.checkoutData.card_id,
              license_plate: this.licensePlate.toString().toUpperCase(),
            }),
          });
          const result = await response.json();
          if (response.ok) {
            this.displayMessage(result.message, "success");
            this.resetView();
          } else {
            this.displayMessage(result.message || "Lỗi khi xác nhận.", "error");
          }
        } catch (error) {
          this.displayMessage("Lỗi kết nối server khi xác nhận vào.", "error");
        }
      },
      async cancelPendingAction() {
        if (!confirm("Bạn có chắc muốn HỦY yêu cầu này? ESP32 sẽ báo lỗi.")) {
          return;
        }
        try {
          await fetch("/api/cancel_pending_action", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ poll_id: this.checkoutData.poll_id }),
          });
          this.displayMessage("Đã hủy yêu cầu.", "info");
          this.resetView();
        } catch (error) {
          this.displayMessage("Lỗi khi hủy yêu cầu.", "error");
        }
      },
      async confirmPendingExit() {
        try {
          const response = await fetch("/api/confirm_pending_exit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              poll_id: this.checkoutData.poll_id,
              transaction_id: this.checkoutData.transaction_id,
              fee: this.checkoutData.fee,
            }),
          });
          const result = await response.json();
          if (response.ok) {
            this.displayMessage(result.message, "success");
            this.resetView();
          } else {
            this.displayMessage(
              result.message || "Lỗi khi xác nhận thanh toán.",
              "error"
            );
          }
        } catch (error) {
          this.displayMessage("Lỗi kết nối server khi xác nhận ra.", "error");
        }
      },
    };
  }
</script>
{% endblock %}
