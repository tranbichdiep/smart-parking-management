{% extends "layout.html" %}
{% block title %}Thống kê Doanh thu{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    
    <div class="flex justify-between items-center border-b pb-4">
        <h1 class="text-3xl font-bold text-slate-800">Báo cáo Thống kê</h1>
        <span class="text-sm text-slate-500 italic">Dữ liệu cập nhật theo thời gian thực</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex items-center space-x-4">
            <div class="p-3 bg-green-100 text-green-600 rounded-full">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-500">Doanh thu Hôm nay</p>
                <p class="text-2xl font-bold text-slate-800">{{ "{:,.0f}".format(revenue_today) }} VNĐ</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex items-center space-x-4">
            <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-500">Lượt xe vào hôm nay</p>
                <p class="text-2xl font-bold text-slate-800">{{ traffic_today }} lượt</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex items-center space-x-4">
            <div class="p-3 bg-orange-100 text-orange-600 rounded-full">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-500">Xe đang gửi</p>
                <p class="text-2xl font-bold text-slate-800">{{ cars_in_parking }} xe</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-700 mb-4">Biểu đồ Doanh thu (7 ngày qua)</h3>
            <canvas id="revenueChart"></canvas>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-700 mb-4">Lưu lượng xe vào (7 ngày qua)</h3>
            <canvas id="trafficChart"></canvas>
        </div>
    </div>
</div>

<script>
    // Lấy dữ liệu từ Flask truyền sang
    const dates = JSON.parse('{{ dates | safe }}');
    const revenues = JSON.parse('{{ revenues | safe }}');
    const traffics = JSON.parse('{{ traffics | safe }}');

    // 1. Cấu hình Biểu đồ Doanh thu (Bar Chart)
    const ctxRev = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctxRev, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: revenues,
                backgroundColor: 'rgba(16, 185, 129, 0.6)', // Màu xanh lá
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.raw.toLocaleString('vi-VN') + ' VNĐ';
                        }
                    }
                }
            }
        }
    });

    // 2. Cấu hình Biểu đồ Lưu lượng (Line Chart)
    const ctxTraff = document.getElementById('trafficChart').getContext('2d');
    new Chart(ctxTraff, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Lượt xe vào',
                data: traffics,
                backgroundColor: 'rgba(59, 130, 246, 0.2)', // Màu xanh dương
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3 // Làm mềm đường cong
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
</script>
{% endblock %}